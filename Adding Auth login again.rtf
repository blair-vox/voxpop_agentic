{\rtf1\ansi\ansicpg1252\cocoartf2822
\cocoatextscaling0\cocoaplatform0{\fonttbl\f0\fswiss\fcharset0 Helvetica;\f1\fnil\fcharset0 .SFNS-Bold;\f2\fswiss\fcharset0 Helvetica-Bold;
\f3\fnil\fcharset0 .SFNS-Regular;\f4\fnil\fcharset0 .AppleSystemUIFontMonospaced-Regular;\f5\fnil\fcharset0 .SFNS-RegularItalic;
\f6\fnil\fcharset0 .AppleSystemUIFontMonospaced-RegularItalic;}
{\colortbl;\red255\green255\blue255;\red14\green14\blue14;}
{\*\expandedcolortbl;;\cssrgb\c6700\c6700\c6700;}
\paperw11900\paperh16840\margl1440\margr1440\vieww16280\viewh15180\viewkind0
\pard\tx720\tx1440\tx2160\tx2880\tx3600\tx4320\tx5040\tx5760\tx6480\tx7200\tx7920\tx8640\pardirnatural\partightenfactor0

\f0\fs24 \cf0 We will now try to implement the following steps, consider the outline of the request below and compare it with the current code base to understand what needs changing and what does not. Some of these features may already be implemented. Find a way to implement the steps even if the exact approach is not quite the same.\
\
<!--\
Cursor Task: Re-enable Cognito login, keep OpenAI calls working, add \'93Past 5 runs\'94 feature.\
Steps:\
 1. Add JWT verifier dependency (fastapi_cognito_jwt).\
 2. Patch backend to protect /personas/run & /runs.\
 3. DynamoDB table user_runs (CDK snippet).\
 4. Amplify Auth init on frontend, simple login/logout & callback page.\
 5. Home page: fetch GET /runs?limit=5 and render past queries.\
-->\
\
# 1\uc0\u65039 \u8419   Add Cognito settings to .env.example\
```file .env.example\
COGNITO_USER_POOL_ID=\
COGNITO_APP_CLIENT_ID=\
COGNITO_REGION=ap-southeast-2\
OPENAI_API_KEY=\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f1\b\fs44 \cf2 2\uc0\u65039 \u8419   Install jwt verifier helper\

\f0\b0\fs24 pip install fastapi-cognito-jwt\
\

\f1\b\fs44 3\uc0\u65039 \u8419   Backend auth dependency\
For a file like this: voxpopai/backend/utils/cognito_auth.py\

\f0\b0\fs24 import os\
from fastapi_cognito_jwt import CognitoOAuth2\
verifier = CognitoOAuth2(\
    userPoolId=os.getenv("COGNITO_USER_POOL_ID"),\
    clientId=os.getenv("COGNITO_APP_CLIENT_ID"),\
    region=os.getenv("COGNITO_REGION"),\
)\
\
def get_current_user(token: str = verifier.token_dependency):\
    return \{"user_id": token["sub"]\}\
\

\f1\b\fs44 4\uc0\u65039 \u8419   Protect routes\
\

\f2\fs24 Patch-file voxpopai/backend/routes/personas.py
\f0\b0 \
@@\
-from fastapi import APIRouter, HTTPException, Request\
+from fastapi import APIRouter, HTTPException, Request, Depends\
+from voxpopai.backend.utils.cognito_auth import get_current_user\
@@\
-@router.post("/run")\
+@router.post("/run", dependencies=[Depends(get_current_user)])\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f3\fs28 \cf2 Same decorator for 
\f4 \cf2 /runs
\f3 \cf2  read endpoint.\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f1\b\fs44 \cf2 5\uc0\u65039 \u8419   DynamoDB table (CDK snippet)\
(This could also be a simple mysql or csv/json file.)\

\f2\fs24 File infra/cdk/users_run_table.py\
\

\f0\b0 from aws_cdk import aws_dynamodb as dynamodb, Stack\
class RunsTable(Stack):\
    def __init__(self, scope, id):\
        super().__init__(scope, id)\
        self.table = dynamodb.Table(\
            self, "UserRuns",\
            partition_key=dynamodb.Attribute(name="user_id", type=dynamodb.AttributeType.STRING),\
            sort_key=dynamodb.Attribute(name="run_id", type=dynamodb.AttributeType.STRING),\
            billing_mode=dynamodb.BillingMode.PAY_PER_REQUEST,\
            removal_policy=dynamodb.RemovalPolicy.DESTROY  # dev only\
        )\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f5\i\fs28 \cf2 Update 
\f6 save_run()
\f5  util to put_item with keys 
\f6 user_id
\f5  and 
\f6 run_id
\f5 .\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f1\i0\b\fs44 \cf2 6\uc0\u65039 \u8419   Front-end auth (Amplify)\

\f2\fs24 File frontend/src/lib/auth.ts\
\

\f0\b0 import \{ Auth \} from "aws-amplify";\
export async function login()   \{ await Auth.federatedSignIn(); \}\
export async function logout()  \{ await Auth.signOut(); \}\
export async function me()      \{ try \{ return await Auth.currentAuthenticatedUser(); \} catch \{ return null; \} \}\
\
Adds aws-exports.js via amplify configure\
\

\f1\b\fs44 7\uc0\u65039 \u8419   Callback page\

\f2\fs24 File frontend/src/pages/callback.tsx\

\f0\b0 import \{ useEffect \} from "react";\
import \{ Auth \} from "aws-amplify";\
export default function Callback()\{\
  useEffect(()=>\{ Auth.currentAuthenticatedUser().then(()=>window.location.href="/"); \},[]);\
  return <p>Signing in\'85</p>;\
\}\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f1\b\fs44 \cf2 8\uc0\u65039 \u8419   Home page \'93Past 5 runs\'94\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f2\fs24 \cf2 Patch-file frontend/src/pages/index.tsx\
\

\f0\b0 @@\
-// top: fetchAuth removed earlier\
+import \{ me \} from "@/lib/auth";\
+useEffect(()=>\{\
+  me().then(async u=>\{\
+    if(u)\{\
+      const r=await api.get("/runs?limit=5");\
+      setPast(r.data);\
+    \}\
+  \});\
+\},[]);\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f3\fs28 \cf2 Render a simple list of the last 5 run summaries.\
\
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0

\f1\b\fs44 \cf2 9\uc0\u65039 \u8419   .gitignore update\

\f2\fs24 File .gitignore\

\f0\b0 aws-exports.js\
\
End of Task.
\f1\b\fs44 \
\pard\tx560\tx1120\tx1680\tx2240\tx2800\tx3360\tx3920\tx4480\tx5040\tx5600\tx6160\tx6720\sl324\slmult1\pardirnatural\partightenfactor0
\cf2 \
\
\
\
}